<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DB-Buddy - AI Database Assistant</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="nav-brand">
            <i class="fas fa-database"></i>
            <span>DB-Buddy</span>
        </div>
        <div class="nav-actions">
            <button class="nav-btn" onclick="showHome()" id="homeBtn">
                <i class="fas fa-home"></i> Home
            </button>
            <a href="/dashboard" class="nav-btn">
                <i class="fas fa-chart-bar"></i> Dashboard
            </a>
            <a href="/analytics" class="nav-btn">
                <i class="fas fa-chart-line"></i> Analytics
            </a>
            <button class="nav-btn" onclick="resetChat()" id="resetBtn" style="display: none;">
                <i class="fas fa-refresh"></i> New Chat
            </button>
        </div>
    </nav>

    <!-- IDP AI Policy Compliance Notice -->
    <div class="idp-policy-banner">
        <div class="policy-content">
            <h3><i class="fas fa-shield-alt"></i> IDP AI Policy Compliance</h3>
            <div class="policy-rules">
                <p><strong>Follow the SMART AI Golden Rules to help protect IDP:</strong></p>
                <div class="rules-grid">
                    <div class="rule-item">
                        <strong><i class="fas fa-lock"></i> Secure Data, Secure Trust</strong><br/>
                        Never enter sensitive, personal, or confidential company data into AI tools.
                    </div>
                    <div class="rule-item">
                        <strong><i class="fas fa-balance-scale"></i> Manage Use Responsibly</strong><br/>
                        Start with clear purpose. Inform your team about AI usage.
                    </div>
                    <div class="rule-item">
                        <strong><i class="fas fa-check-circle"></i> Accountable for Outcomes</strong><br/>
                        Always verify AI outputs. You own the outcomes.
                    </div>
                    <div class="rule-item">
                        <strong><i class="fas fa-search"></i> Review, Monitor, Improve</strong><br/>
                        Pilot first. Monitor performance. Keep improving.
                    </div>
                </div>
                <div class="transparency-rule">
                    <strong><i class="fas fa-handshake"></i> Transparent and Ethical:</strong> Check for bias. Be open about AI use.
                </div>
            </div>
        </div>
    </div>

    <div class="main-container">
        <!-- Welcome Screen -->
        <div class="welcome-screen" id="welcomeScreen">
            <div class="hero-section">
                <div class="hero-content">
                    <h1>üóÑÔ∏è DB-Buddy - Official DBM ChatOps</h1>
                    <p class="hero-subtitle"><strong>Enterprise Database Operations Assistant</strong> | L1/L2 Support Before Escalation | Official DBM Team Tool</p>
                    <div class="enterprise-workflow">
                        <div class="workflow-content">
                            <h4>Enterprise Operations Workflow:</h4>
                            <p>1. Select operation type ‚Üí 2. Provide system details ‚Üí 3. Get L1/L2 resolution ‚Üí 4. Escalate to DBM if needed</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Value Proposition Section -->
            <div class="value-section">
                <div class="value-grid">
                    <div class="value-card">
                        <div class="value-icon">
                            <i class="fas fa-rocket"></i>
                        </div>
                        <h3>10x Faster Problem Solving</h3>
                        <p>Get instant solutions instead of spending hours researching documentation and forums</p>
                    </div>
                    <div class="value-card">
                        <div class="value-icon">
                            <i class="fas fa-microscope"></i>
                        </div>
                        <h3>Deep SQL Analysis</h3>
                        <p>Paste your SQL queries and execution plans for immediate, specific optimization recommendations</p>
                    </div>
                    <div class="value-card">
                        <div class="value-icon">
                            <i class="fas fa-cloud"></i>
                        </div>
                        <h3>Multi-Cloud Expert</h3>
                        <p>Specialized knowledge for AWS, Azure, GCP with cloud-specific best practices and configurations</p>
                    </div>
                    <div class="value-card">
                        <div class="value-icon">
                            <i class="fas fa-shield-check"></i>
                        </div>
                        <h3>Production-Ready Solutions</h3>
                        <p>Get enterprise-grade recommendations with security, performance, and scalability in mind</p>
                    </div>
                </div>
            </div>
            
            <!-- Benefits Section -->
            <div class="benefits-section">
                <h2>Why Choose DB-Buddy?</h2>
                <div class="benefits-grid">
                    <div class="benefit-item">
                        <i class="fas fa-check-circle"></i>
                        <div>
                            <h4>Reduce DBA Workload</h4>
                            <p>Handle 80% of common database issues without escalating to your DBA team</p>
                        </div>
                    </div>
                    <div class="benefit-item">
                        <i class="fas fa-check-circle"></i>
                        <div>
                            <h4>Minimize Downtime</h4>
                            <p>Get immediate troubleshooting steps for critical production issues</p>
                        </div>
                    </div>
                    <div class="benefit-item">
                        <i class="fas fa-check-circle"></i>
                        <div>
                            <h4>Optimize Performance</h4>
                            <p>Identify bottlenecks and get specific index recommendations with expected improvements</p>
                        </div>
                    </div>
                    <div class="benefit-item">
                        <i class="fas fa-check-circle"></i>
                        <div>
                            <h4>Save Development Time</h4>
                        <p>Stop context-switching to research database issues - get answers instantly</p>
                        </div>
                    </div>
                    <div class="benefit-item">
                        <i class="fas fa-check-circle"></i>
                        <div>
                            <h4>Learn Best Practices</h4>
                            <p>Understand the 'why' behind recommendations to improve your database skills</p>
                        </div>
                    </div>
                    <div class="benefit-item">
                        <i class="fas fa-check-circle"></i>
                        <div>
                            <h4>Cost Optimization</h4>
                            <p>Right-size your infrastructure and optimize cloud database costs</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- How It Works Section -->
            <div class="how-it-works-section">
                <h2>How It Works</h2>
                <div class="steps-container">
                    <div class="step">
                        <div class="step-number">1</div>
                        <div class="step-content">
                            <h4>Choose Your Service</h4>
                            <p>Select from troubleshooting, query optimization, performance analysis, architecture design, capacity planning, or security</p>
                        </div>
                    </div>
                    <div class="step">
                        <div class="step-number">2</div>
                        <div class="step-content">
                            <h4>Describe Your Situation</h4>
                            <p>Share your SQL queries, error messages, execution plans, or describe your requirements in plain English</p>
                        </div>
                    </div>
                    <div class="step">
                        <div class="step-number">3</div>
                        <div class="step-content">
                            <h4>Get Expert Recommendations</h4>
                            <p>Receive specific, actionable solutions with exact commands, configurations, and expected results</p>
                        </div>
                    </div>
                    <div class="step">
                        <div class="step-number">4</div>
                        <div class="step-content">
                            <h4>Implement & Verify</h4>
                            <p>Follow the provided steps and use diagnostic queries to verify improvements</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="services-section">
                <h2>Choose Your Database Challenge</h2>
                <div class="service-cards">
                    <div class="service-card" onclick="startConversation('troubleshooting')">
                        <div class="card-icon troubleshooting-icon">
                            <i class="fas fa-wrench"></i>
                        </div>
                        <h3>üîß L1 Troubleshooting</h3>
                        <p>Connection timeouts, authentication issues, standard error diagnosis, performance monitoring, routine maintenance operations</p>
                        <div class="card-arrow">
                            <i class="fas fa-arrow-right"></i>
                        </div>
                    </div>
                    
                    <div class="service-card" onclick="startConversation('query')">
                        <div class="card-icon query-icon">
                            <i class="fas fa-bolt"></i>
                        </div>
                        <h3>‚ö° L2 Query Optimization</h3>
                        <p>SQL query performance analysis, index recommendations, execution plan analysis, query rewriting for performance</p>
                        <div class="card-arrow">
                            <i class="fas fa-arrow-right"></i>
                        </div>
                    </div>
                    
                    <div class="service-card" onclick="startConversation('performance')">
                        <div class="card-icon performance-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <h3>üìä L2 Performance Analysis</h3>
                        <p>Resource utilization assessment, capacity planning recommendations, monitoring setup, performance baseline establishment</p>
                        <div class="card-arrow">
                            <i class="fas fa-arrow-right"></i>
                        </div>
                    </div>
                    
                    <div class="service-card" onclick="startConversation('architecture')">
                        <div class="card-icon architecture-icon">
                            <i class="fas fa-sitemap"></i>
                        </div>
                        <h3>Architecture & Design</h3>
                        <p>Schema design, normalization, partitioning, replication, and database structure planning</p>
                        <div class="card-arrow">
                            <i class="fas fa-arrow-right"></i>
                        </div>
                    </div>
                    
                    <div class="service-card" onclick="startConversation('capacity')">
                        <div class="card-icon capacity-icon">
                            <i class="fas fa-server"></i>
                        </div>
                        <h3>Capacity Planning</h3>
                        <p>Hardware sizing, scaling strategies, growth planning, and infrastructure recommendations</p>
                        <div class="card-arrow">
                            <i class="fas fa-arrow-right"></i>
                        </div>
                    </div>
                    
                    <div class="service-card" onclick="startConversation('security')">
                        <div class="card-icon security-icon">
                            <i class="fas fa-shield-check"></i>
                        </div>
                        <h3>üîê L1/L2 Security Operations</h3>
                        <p>Access control verification, security configuration review, compliance check procedures, audit log analysis</p>
                        <div class="card-arrow">
                            <i class="fas fa-arrow-right"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Chat Interface -->
        <div class="chat-interface" id="chatInterface" style="display: none;">
            <div class="chat-header">
                <div class="chat-title">
                    <i class="fas fa-comments"></i>
                    <span id="chatTitle">DB Assistant</span>
                </div>
                <div class="chat-status">
                    <div class="status-indicator online"></div>
                    <span id="aiStatus">Online</span>
                </div>
            </div>
            
            <!-- Quick Selectors moved to top -->
            <div class="quick-selectors-top" id="quickSelectors">
                <div class="selector-row">
                    <div class="selector-group">
                        <label>Deployment:</label>
                        <select id="deploymentSelect" onchange="updateCloudProvider()">
                            <option value="">Select...</option>
                            <option value="On-Premises">On-Premises</option>
                            <option value="Cloud">Cloud</option>
                            <option value="Hybrid">Hybrid</option>
                        </select>
                    </div>
                    <div class="selector-group" id="cloudProviderGroup" style="display: none;">
                        <label>Cloud Provider:</label>
                        <select id="cloudProviderSelect" onchange="updateDatabaseOptions()">
                            <option value="">Select...</option>
                            <option value="AWS">AWS</option>
                            <option value="Azure">Azure</option>
                            <option value="GCP">Google Cloud</option>
                            <option value="Oracle Cloud">Oracle Cloud</option>
                            <option value="IBM Cloud">IBM Cloud</option>
                        </select>
                    </div>
                    <div class="selector-group">
                        <label>Database System:</label>
                        <select id="dbSystemSelect">
                            <option value="">Select...</option>
                            <option value="MySQL">MySQL</option>
                            <option value="PostgreSQL">PostgreSQL</option>
                            <option value="SQL Server">SQL Server</option>
                            <option value="Oracle">Oracle</option>
                            <option value="MongoDB">MongoDB</option>
                            <option value="Redis">Redis</option>
                            <option value="MariaDB">MariaDB</option>
                            <option value="Cassandra">Cassandra</option>
                        </select>
                    </div>
                    <div class="selector-group" id="issueTypeGroup">
                        <label>Issue Type:</label>
                        <select id="issueTypeSelect">
                            <option value="">Select...</option>
                        </select>
                    </div>
                    <div class="selector-group">
                        <label>Environment:</label>
                        <select id="environmentSelect">
                            <option value="">Select...</option>
                            <option value="Development">Development</option>
                            <option value="Staging">Staging</option>
                            <option value="Production">Production</option>
                        </select>
                    </div>
                    <button onclick="insertSelections()" class="insert-btn">
                        <i class="fas fa-plus"></i> Insert
                    </button>
                </div>
            </div>
            
            <div class="chat-messages" id="chatMessages">
                <div class="typing-indicator" id="typingIndicator" style="display: none;">
                    <div class="typing-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                    <span class="typing-text">DB-Buddy is thinking...</span>
                </div>
            </div>
            
            <!-- Natural Language SQL Panel -->
            <div id="nlSqlPanel" class="nl-sql-panel" style="display: none;">
                <div class="nl-sql-header">
                    <h4><i class="fas fa-robot"></i> Natural Language to SQL</h4>
                    <button onclick="toggleNLSQL()" class="close-btn">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="nl-sql-form">
                    <textarea id="nlQuery" placeholder="Describe what data you want in plain English...\nExample: 'Show me all customers who placed orders last month'" rows="3"></textarea>
                    <div class="db-config">
                        <select id="dbType">
                            <option value="postgresql">PostgreSQL</option>
                            <option value="mysql">MySQL</option>
                            <option value="sqlite">SQLite</option>
                        </select>
                        <input type="text" id="dbHost" placeholder="Host (optional)" />
                        <input type="text" id="dbName" placeholder="Database Name" />
                    </div>
                    <div class="nl-sql-buttons">
                        <button onclick="generateSQL()" class="btn btn-primary">
                            <i class="fas fa-magic"></i> Generate SQL
                        </button>
                        <button onclick="executeSQL()" class="btn btn-success">
                            <i class="fas fa-play"></i> Execute Query
                        </button>
                    </div>
                </div>
                <div id="sqlResult" class="sql-result"></div>
            </div>
            
            <div class="chat-input-container">
                <div class="input-wrapper">
                    <input type="file" id="imageInput" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
                    <button onclick="document.getElementById('imageInput').click()" class="attachment-btn" title="Upload Screenshot">
                        <i class="fas fa-image"></i>
                    </button>
                    <textarea id="userInput" placeholder="Type your message here... (Shift+Enter for new line, Enter to send)" onkeydown="handleKeyPress(event)" rows="1"></textarea>
                    <button onclick="generateReport()" class="report-btn" title="Generate PDF Report">
                        <i class="fas fa-file-pdf"></i>
                    </button>
                    <button onclick="toggleNLSQL()" class="nl-sql-btn" title="Natural Language SQL">
                        <i class="fas fa-robot"></i>
                    </button>
                    <button onclick="sendAnswer()" id="sendBtn" class="send-btn">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
                <div class="input-help">
                    <small><i class="fas fa-info-circle"></i> Use quick selectors above, upload screenshots, or try Natural Language SQL</small>
                </div>
            </div>
        </div>
    </div>
    
    <script src="{{ url_for('static', filename='script.js') }}"></script>
    <script>
        // Natural Language SQL functionality
        function toggleNLSQL() {
            const panel = document.getElementById('nlSqlPanel');
            const isVisible = panel.style.display !== 'none';
            panel.style.display = isVisible ? 'none' : 'block';
            
            if (!isVisible) {
                document.getElementById('nlQuery').focus();
            }
        }
        
        async function generateSQL() {
            const query = document.getElementById('nlQuery').value;
            if (!query.trim()) {
                alert('Please enter a query description');
                return;
            }
            
            const dbConfig = {
                type: document.getElementById('dbType').value,
                host: document.getElementById('dbHost').value || 'localhost',
                database: document.getElementById('dbName').value || 'demo_db'
            };
            
            const resultDiv = document.getElementById('sqlResult');
            resultDiv.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Generating SQL...</div>';
            
            try {
                const response = await fetch('/api/nl-sql', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query, db_config: dbConfig })
                });
                
                const result = await response.json();
                displaySQLResult(result);
            } catch (error) {
                resultDiv.innerHTML = `<div class="error"><i class="fas fa-exclamation-triangle"></i> Error: ${error.message}</div>`;
            }
        }
        
        function displaySQLResult(result) {
            const resultDiv = document.getElementById('sqlResult');
            
            if (result.error) {
                resultDiv.innerHTML = `<div class="error"><i class="fas fa-exclamation-triangle"></i> ${result.error}</div>`;
                return;
            }
            
            let html = `
                <div class="sql-success">
                    <h5><i class="fas fa-check-circle"></i> Generated SQL Query:</h5>
                    <div class="sql-code">
                        <pre><code>${result.generated_sql}</code></pre>
                        <button onclick="copySQLToClipboard('${result.generated_sql.replace(/'/g, "\\'")}')") class="copy-btn" title="Copy SQL">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                    <div class="sql-meta">
                        <span class="confidence"><i class="fas fa-chart-bar"></i> Confidence: ${(result.confidence * 100).toFixed(1)}%</span>
                        <span class="schema-info"><i class="fas fa-database"></i> Tables: ${result.schema_used}</span>
                    </div>
                    <div class="explanation">
                        <h6><i class="fas fa-lightbulb"></i> Explanation:</h6>
                        <p>${result.explanation}</p>
                    </div>
                </div>
            `;
            
            if (result.execution_result && result.execution_result.success) {
                html += `
                    <div class="execution-result">
                        <h5><i class="fas fa-play-circle"></i> Execution Result:</h5>
                        <div class="result-stats">
                            <span><i class="fas fa-list-ol"></i> Rows: ${result.execution_result.row_count}</span>
                            <span><i class="fas fa-columns"></i> Columns: ${result.execution_result.columns ? result.execution_result.columns.join(', ') : 'N/A'}</span>
                        </div>
                    </div>
                `;
            }
            
            resultDiv.innerHTML = html;
        }
        
        function copySQLToClipboard(sql) {
            navigator.clipboard.writeText(sql).then(() => {
                // Show temporary success message
                const btn = event.target.closest('.copy-btn');
                const originalHTML = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check"></i>';
                btn.style.color = '#28a745';
                setTimeout(() => {
                    btn.innerHTML = originalHTML;
                    btn.style.color = '';
                }, 2000);
            });
        }
        
        async function executeSQL() {
            const query = document.getElementById('nlQuery').value;
            if (!query.trim()) {
                alert('Please generate SQL first');
                return;
            }
            
            // For demo purposes - in production this would execute the actual SQL
            const resultDiv = document.getElementById('sqlResult');
            const currentContent = resultDiv.innerHTML;
            
            resultDiv.innerHTML = currentContent + '<div class="demo-notice"><i class="fas fa-info-circle"></i> Demo Mode: SQL execution requires database connection. Use the generated SQL in your database client.</div>';
        }
    </script>
</body>
</html>